<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>NFC Tap (No Firebase)</title>
</head>
<body>
  <div id="app">กำลังสร้างโทเคนใหม่...</div>

  <script>
    const app = document.getElementById("app");

    function show(msg) {
      app.innerHTML = msg;
    }

    // ฟังก์ชันสร้างโทเคนแบบสุ่ม
    function generateToken() {
      return Math.random().toString(36).slice(2, 10); // เช่น "k3f9ab1z"
    }

    function getTokenStore() {
      // ดึงข้อมูล token ทั้งหมดที่เคยสร้างในเครื่องนี้จาก localStorage
      const raw = localStorage.getItem("tokensStore");
      if (!raw) return {};
      try {
        return JSON.parse(raw);
      } catch (e) {
        return {};
      }
    }

    function saveTokenStore(store) {
      localStorage.setItem("tokensStore", JSON.stringify(store));
    }

    function main() {
      const store = getTokenStore();
      const newToken = generateToken();

      // เก็บโทเคนใหม่ใน store ของเครื่องนี้
      store[newToken] = { used: false, createdAt: Date.now() };
      saveTokenStore(store);

      show(`สร้างโทเคนใหม่แล้ว: <b>${newToken}</b><br>กำลังพาไปหน้า secure...`);

      // เด้งไปหน้า secure.html พร้อมโทเคนใหม่
      setTimeout(() => {
        window.location.href = `index.html?token=${encodeURIComponent(newToken)}`;
      }, 700);
    }

    main();
  </script>
</body>
</html>
